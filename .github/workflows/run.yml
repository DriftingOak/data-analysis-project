name: Polymarket Bot

on:
  # Run every 6 hours for paper trading
  schedule:
    - cron: '0 */6 * * *'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode'
        required: true
        default: 'paper'
        type: choice
        options:
          - paper              # Standard strategies (4)
          - paper_unlimited    # Unlimited strategies (4)
          - paper_experimental # Experimental strategies
          - paper_all          # ALL strategies
          - paper_quick        # Quick test (balanced + unlimited_balanced)
          - dry_run
          - scan_only
          - live

# Required for pushing commits and deploying pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      # Scheduled runs: standard + unlimited strategies
      - name: Run bot (scheduled)
        if: github.event_name == 'schedule'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "Running standard strategies..."
          python bot.py --paper standard
          echo ""
          echo "Running unlimited strategies..."
          python bot.py --paper unlimited
      
      # Manual runs
      - name: Run bot (manual)
        if: github.event_name == 'workflow_dispatch'
        env:
          POLYMARKET_API_KEY: ${{ secrets.POLYMARKET_API_KEY }}
          POLYMARKET_SECRET: ${{ secrets.POLYMARKET_SECRET }}
          POLYMARKET_PASSPHRASE: ${{ secrets.POLYMARKET_PASSPHRASE }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MODE="${{ inputs.mode }}"
          
          if [ "$MODE" = "scan_only" ]; then
            python bot.py --scan-only
          elif [ "$MODE" = "live" ]; then
            python bot.py --live <<< "CONFIRM"
          elif [ "$MODE" = "dry_run" ]; then
            python bot.py
          elif [ "$MODE" = "paper" ]; then
            python bot.py --paper standard
          elif [ "$MODE" = "paper_unlimited" ]; then
            python bot.py --paper unlimited
          elif [ "$MODE" = "paper_experimental" ]; then
            python bot.py --paper experimental
          elif [ "$MODE" = "paper_all" ]; then
            python bot.py --paper all
          elif [ "$MODE" = "paper_quick" ]; then
            python bot.py --paper quick
          else
            python bot.py --paper
          fi
      
      # Commit portfolio changes and snapshots
      - name: Commit changes
        run: |
          echo "=== Files to commit ==="
          ls -la portfolio_*.json 2>/dev/null || echo "No portfolio files"
          ls -la snapshots/ 2>/dev/null || echo "No snapshots directory"
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add portfolio files
          git add portfolio_*.json 2>/dev/null || true
          
          # Add snapshot files (create dir if needed)
          mkdir -p snapshots
          git add snapshots/*.json 2>/dev/null || true
          
          # Add bot history
          git add bot_history.json 2>/dev/null || true
          
          # Commit if there are changes
          git diff --staged --quiet || git commit -m "Bot run: $(date -u '+%Y-%m-%d %H:%M') UTC"
          
          # Pull and push
          git pull --rebase origin main || true
          git push origin main || echo "Nothing to push"
      
      # Generate and deploy dashboard
      - name: Generate dashboard
        run: |
          python generate_dashboard.py || echo "Dashboard generation failed"
      
      - name: Setup Pages
        if: always()
        uses: actions/configure-pages@v4
      
      - name: Upload dashboard artifact
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        if: always()
        id: deployment
        uses: actions/deploy-pages@v4

  # Cleanup old snapshots (runs weekly)
  cleanup-snapshots:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 0 * * 0'  # Sundays at midnight
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Cleanup old snapshots
        run: |
          # Keep only last 30 days of snapshots
          cd snapshots 2>/dev/null || exit 0
          
          CUTOFF=$(date -d '30 days ago' +%Y%m%d)
          
          for f in snapshot_*.json; do
            # Extract date from filename (snapshot_YYYYMMDD_HHMMSS.json)
            DATE=$(echo "$f" | grep -oP '\d{8}' | head -1)
            if [ "$DATE" -lt "$CUTOFF" ]; then
              echo "Deleting old snapshot: $f"
              rm "$f"
            fi
          done
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --staged --quiet || git commit -m "Cleanup: remove snapshots older than 30 days"
          git push origin main || true
