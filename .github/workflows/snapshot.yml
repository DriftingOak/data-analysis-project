name: Snapshot Dataset

# ============================================================================
# SNAPSHOT PIPELINE - INDÃ‰PENDANT DU BOT
# ============================================================================
# Ce workflow collecte les snapshots pour backtesting.
# Il ne fait PAS de trading, il ne touche PAS aux portfolios.
#
# Schedule dÃ©calÃ© de 30min par rapport au bot pour Ã©viter les conflits de push.
# ============================================================================

on:
  schedule:
    # Toutes les 6h, dÃ©calÃ© de 30min: 00:30, 06:30, 12:30, 18:30 UTC
    - cron: '30 */6 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no save)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

jobs:
  snapshot:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run snapshot collector
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            python collect_snapshot.py --dry-run
          else
            python collect_snapshot.py
          fi

      - name: Commit snapshots
        if: inputs.dry_run != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Pull latest to avoid conflicts with bot workflow
          git pull --rebase origin main || true
          
          # Add only snapshot files
          mkdir -p snapshots
          git add snapshots/*.json 2>/dev/null || true
          
          # Commit if changes
          if git diff --staged --quiet; then
            echo "No new snapshots to commit"
          else
            git commit -m "ðŸ“¸ Snapshot $(date -u '+%Y-%m-%d %H:%M') UTC"
            git push origin main
          fi

  # ============================================================================
  # CLEANUP - Weekly
  # ============================================================================
  cleanup:
    runs-on: ubuntu-latest
    # Only run on Sunday at 00:30 UTC
    if: github.event.schedule == '30 0 * * 0'
    needs: snapshot
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old snapshots
        run: |
          # Keep 60 days of snapshots
          DAYS_TO_KEEP=60
          CUTOFF_DATE=$(date -d "-${DAYS_TO_KEEP} days" +%Y%m%d)
          
          echo "Removing snapshots older than $CUTOFF_DATE..."
          
          if [ -d "snapshots" ]; then
            cd snapshots
            count=0
            for f in snapshot_*.json; do
              if [ -f "$f" ]; then
                # Extract date from filename (snapshot_YYYYMMDD_HHMMSS.json)
                file_date=$(echo "$f" | sed 's/snapshot_\([0-9]*\)_.*/\1/')
                if [ "$file_date" -lt "$CUTOFF_DATE" ] 2>/dev/null; then
                  echo "Removing $f (date: $file_date)"
                  rm "$f"
                  count=$((count + 1))
                fi
              fi
            done
            echo "Removed $count old snapshot files"
            cd ..
          fi

      - name: Commit cleanup
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add -A snapshots/
          
          if git diff --staged --quiet; then
            echo "No files to clean up"
          else
            git commit -m "ðŸ§¹ Cleanup snapshots older than 60 days"
            git push origin main
          fi
